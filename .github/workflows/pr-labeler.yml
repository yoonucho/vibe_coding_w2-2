name: PR Auto Labeler

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  label-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Auto label PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title.toLowerCase();
            const body = (pr.body || '').toLowerCase();
            const labels = [];

            // ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ ì»´í¬ë„ŒíŠ¸ ë¼ë²¨
            const pathLabels = {
              'backend/': 'component:backend',
              'frontend/': 'component:frontend',
              'docs/': 'component:docs',
              '.github/': 'component:ci-cd',
              'tests/': 'component:tests',
              'requirements.txt': 'dependencies'
            };

            // ë³€ê²½ëœ íŒŒì¼ì— ë”°ë¥¸ ë¼ë²¨ ì¶”ê°€
            for (const file of files) {
              for (const [path, label] of Object.entries(pathLabels)) {
                if (file.filename.includes(path)) {
                  if (!labels.includes(label)) {
                    labels.push(label);
                  }
                }
              }
            }

            // PR ì œëª©/ë‚´ìš© ê¸°ë°˜ íƒ€ì… ë¼ë²¨
            const typePatterns = {
              'type:feature': ['feat', 'feature', 'add', 'implement', 'new'],
              'type:bugfix': ['fix', 'bug', 'bugfix', 'resolve', 'patch'],
              'type:hotfix': ['hotfix', 'urgent', 'critical', 'emergency'],
              'type:refactor': ['refactor', 'cleanup', 'optimize', 'improve'],
              'type:docs': ['docs', 'documentation', 'readme', 'comment'],
              'type:test': ['test', 'testing', 'spec', 'coverage'],
              'type:chore': ['chore', 'maintenance', 'config', 'setup']
            };

            for (const [label, patterns] of Object.entries(typePatterns)) {
              if (patterns.some(pattern => title.includes(pattern) || body.includes(pattern))) {
                if (!labels.includes(label)) {
                  labels.push(label);
                }
                break; // ì²« ë²ˆì§¸ ë§¤ì¹­ë˜ëŠ” íƒ€ì…ë§Œ ì ìš©
              }
            }

            // íŒŒì¼ ë³€ê²½ëŸ‰ì— ë”°ë¥¸ í¬ê¸° ë¼ë²¨
            const totalChanges = files.reduce((sum, file) => sum + file.changes, 0);

            if (totalChanges > 500) {
              labels.push('size:large');
            } else if (totalChanges > 100) {
              labels.push('size:medium');
            } else {
              labels.push('size:small');
            }

            // ìš°ì„ ìˆœìœ„ ë¼ë²¨ (í‚¤ì›Œë“œ ê¸°ë°˜)
            const priorityPatterns = {
              'priority:high': ['urgent', 'critical', 'hotfix', 'breaking'],
              'priority:medium': ['important', 'feature', 'enhancement'],
              'priority:low': ['minor', 'docs', 'cleanup', 'chore']
            };

            for (const [label, patterns] of Object.entries(priorityPatterns)) {
              if (patterns.some(pattern => title.includes(pattern) || body.includes(pattern))) {
                if (!labels.includes(label)) {
                  labels.push(label);
                }
                break;
              }
            }

            // ê¸°ë³¸ ìš°ì„ ìˆœìœ„ ì„¤ì •
            if (!labels.some(label => label.startsWith('priority:'))) {
              labels.push('priority:medium');
            }

            // ë¸Œë ˆì´í‚¹ ì²´ì¸ì§€ ê°ì§€
            if (title.includes('breaking') || body.includes('breaking change')) {
              labels.push('breaking-change');
            }

            // ë¼ë²¨ ì ìš©
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
              
              // ë¼ë²¨ë§ ê²°ê³¼ ëŒ“ê¸€
              const comment = `## ğŸ·ï¸ ìë™ ë¼ë²¨ë§ ì™„ë£Œ

            ë‹¤ìŒ ë¼ë²¨ì´ ìë™ìœ¼ë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤:
            ${labels.map(label => `- \`${label}\``).join('\n')}

            ### ë¼ë²¨ë§ ê¸°ì¤€:
            - **íƒ€ì…**: PR ì œëª©/ë‚´ìš©ì˜ í‚¤ì›Œë“œ ë¶„ì„
            - **ì»´í¬ë„ŒíŠ¸**: ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œ ê¸°ë°˜
            - **í¬ê¸°**: ì´ ë³€ê²½ ë¼ì¸ ìˆ˜ (${totalChanges}ì¤„)
            - **ìš°ì„ ìˆœìœ„**: í‚¤ì›Œë“œ ë° ë³€ê²½ ë²”ìœ„ ë¶„ì„

            ---
            ğŸ¤– ë¼ë²¨ì€ PR ë‚´ìš© ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  create-labels:
    runs-on: ubuntu-latest

    steps:
      - name: Create required labels
        uses: actions/github-script@v7
        with:
          script: |
            const requiredLabels = [
              { name: 'type:feature', color: '00ff00', description: 'New feature or enhancement' },
              { name: 'type:bugfix', color: 'ff0000', description: 'Bug fix' },
              { name: 'type:hotfix', color: 'ff6600', description: 'Urgent fix' },
              { name: 'type:refactor', color: '0066ff', description: 'Code refactoring' },
              { name: 'type:docs', color: '6600ff', description: 'Documentation changes' },
              { name: 'type:test', color: 'ffff00', description: 'Test related changes' },
              { name: 'type:chore', color: '999999', description: 'Maintenance tasks' },
              { name: 'component:backend', color: '009900', description: 'Backend related' },
              { name: 'component:frontend', color: '0099ff', description: 'Frontend related' },
              { name: 'component:docs', color: '9900ff', description: 'Documentation related' },
              { name: 'component:ci-cd', color: 'ff9900', description: 'CI/CD related' },
              { name: 'component:tests', color: 'ffff99', description: 'Test related' },
              { name: 'size:small', color: 'c2e0c6', description: 'Small changes' },
              { name: 'size:medium', color: 'ffd86e', description: 'Medium changes' },
              { name: 'size:large', color: 'ff6b6b', description: 'Large changes' },
              { name: 'priority:high', color: 'ff4757', description: 'High priority' },
              { name: 'priority:medium', color: 'feca57', description: 'Medium priority' },
              { name: 'priority:low', color: '48dbfb', description: 'Low priority' },
              { name: 'breaking-change', color: 'ff0000', description: 'Breaking change' },
              { name: 'dependencies', color: '663399', description: 'Dependency changes' }
            ];

            for (const label of requiredLabels) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
                console.log(`Created label: ${label.name}`);
              } catch (error) {
                if (error.status !== 422) { // 422ëŠ” ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë¼ë²¨
                  console.error(`Failed to create label ${label.name}:`, error);
                }
              }
            }
