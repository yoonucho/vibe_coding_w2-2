name: PR Auto Assigner

on:
  pull_request:
    types: [opened, ready_for_review]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Auto assign reviewers
        uses: actions/github-script@v7
        with:
          script: |
            // í”„ë¡œì íŠ¸ íŒ€ì› ëª©ë¡ (ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
            const teamMembers = [
              'reviewer1',
              'reviewer2',
              'reviewer3'
            ];

            // ì½”ë“œ ì˜ì—­ë³„ ì „ë¬¸ê°€ ë§¤í•‘
            const codeOwners = {
              'backend/': ['backend-expert1', 'backend-expert2'],
              'frontend/': ['frontend-expert1', 'frontend-expert2'],
              'docs/': ['docs-maintainer'],
              '.github/': ['devops-expert']
            };

            const pr = context.payload.pull_request;
            const author = pr.user.login;

            // PR ì‘ì„±ìë¥¼ ì œì™¸í•œ íŒ€ì› ëª©ë¡
            const availableReviewers = teamMembers.filter(member => member !== author);

            // ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ìœ¼ë¡œ ì „ë¬¸ê°€ ì°¾ê¸°
            let expertReviewers = new Set();

            for (const file of files) {
              for (const [path, experts] of Object.entries(codeOwners)) {
                if (file.filename.startsWith(path)) {
                  experts.forEach(expert => {
                    if (expert !== author && teamMembers.includes(expert)) {
                      expertReviewers.add(expert);
                    }
                  });
                }
              }
            }

            // ì „ë¬¸ê°€ê°€ ì—†ìœ¼ë©´ ì¼ë°˜ íŒ€ì›ì—ì„œ ë¬´ì‘ìœ„ ì„ íƒ
            let selectedReviewers = Array.from(expertReviewers);

            if (selectedReviewers.length === 0 && availableReviewers.length > 0) {
              // ë¬´ì‘ìœ„ë¡œ 1-2ëª… ì„ íƒ
              const numReviewers = Math.min(2, availableReviewers.length);
              selectedReviewers = availableReviewers
                .sort(() => 0.5 - Math.random())
                .slice(0, numReviewers);
            }

            // ìµœëŒ€ 3ëª…ê¹Œì§€ë§Œ í• ë‹¹
            selectedReviewers = selectedReviewers.slice(0, 3);

            if (selectedReviewers.length > 0) {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                reviewers: selectedReviewers
              });
              
              // í• ë‹¹ ê²°ê³¼ ëŒ“ê¸€
              const comment = `## ğŸ‘¥ ë¦¬ë·°ì–´ ìë™ í• ë‹¹

            ë‹¤ìŒ íŒ€ì›ë“¤ì´ ë¦¬ë·°ì–´ë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤:
            ${selectedReviewers.map(reviewer => `- @${reviewer}`).join('\n')}

            ${expertReviewers.size > 0 ? 
              'ğŸ¯ ë³€ê²½ëœ ì½”ë“œ ì˜ì—­ì˜ ì „ë¬¸ê°€ê°€ ìš°ì„  í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.' : 
              'ğŸ”„ íŒ€ì› ìˆœí™˜ í• ë‹¹ ì‹œìŠ¤í…œì— ë”°ë¼ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.'
            }

            ---
            ğŸ¤– ì´ í• ë‹¹ì€ ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  assign-pr-author:
    runs-on: ubuntu-latest

    steps:
      - name: Assign PR author
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;

            // PR ì‘ì„±ìë¥¼ Assigneeë¡œ ì„¤ì •
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              assignees: [author]
            });
