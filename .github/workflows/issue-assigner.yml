name: Issue Auto Assigner

on:
  issues:
    types: [opened]

jobs:
  assign-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Auto assign issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();

                      // íŒ€ì› ë° ì „ë¬¸ê°€ ì •ì˜
          const teamMembers = {
            backend: ['yoonucho'],
            frontend: ['yoonucho'],
            fullstack: ['yoonucho'],
            docs: ['yoonucho'],
            devops: ['yoonucho'],
            maintenance: ['yoonucho']
          };

            // ì´ìŠˆ íƒ€ì… ë° ì»´í¬ë„ŒíŠ¸ ê°ì§€
            let assigneeCategory = 'maintenance'; // ê¸°ë³¸ê°’

            // ì´ìŠˆ íƒ€ì…ë³„ ë‹´ë‹¹ì ê²°ì •
            if (title.includes('backend') || body.includes('backend') || 
                title.includes('api') || body.includes('api') ||
                title.includes('server') || body.includes('server')) {
              assigneeCategory = 'backend';
            } else if (title.includes('frontend') || body.includes('frontend') ||
                      title.includes('ui') || body.includes('ui') ||
                      title.includes('interface') || body.includes('interface')) {
              assigneeCategory = 'frontend';
            } else if (title.includes('docs') || title.includes('documentation') ||
                      body.includes('docs') || body.includes('documentation')) {
              assigneeCategory = 'docs';
            } else if (title.includes('ci') || title.includes('cd') ||
                      title.includes('deploy') || body.includes('deploy') ||
                      title.includes('github action')) {
              assigneeCategory = 'devops';
            } else if (title.includes('bug') || body.includes('bug')) {
              // ë²„ê·¸ëŠ” í’€ìŠ¤íƒ ê°œë°œìë‚˜ ê´€ë ¨ ì»´í¬ë„ŒíŠ¸ ì „ë¬¸ê°€ê°€ ì²˜ë¦¬
              assigneeCategory = 'fullstack';
            }

            // ìš°ì„ ìˆœìœ„ ê¸°ë°˜ í• ë‹¹ ë¡œì§
            const isUrgent = title.includes('urgent') || title.includes('critical') ||
                            body.includes('urgent') || body.includes('critical');

            // ë‹´ë‹¹ì ì„ íƒ
            const candidates = teamMembers[assigneeCategory] || teamMembers.maintenance;
            let selectedAssignee;

            if (candidates.length > 0) {
              // ë¼ìš´ë“œ ë¡œë¹ˆ ë°©ì‹ìœ¼ë¡œ í• ë‹¹ (ê°„ë‹¨í•œ í•´ì‹œ ê¸°ë°˜)
              const hash = issue.number % candidates.length;
              selectedAssignee = candidates[hash];
            }

            if (selectedAssignee) {
              // ë‹´ë‹¹ì í• ë‹¹
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                assignees: [selectedAssignee]
              });
              
              // í• ë‹¹ ê²°ê³¼ ëŒ“ê¸€
              const urgentText = isUrgent ? 'ğŸš¨ **ê¸´ê¸‰ ì´ìŠˆ**' : '';
              const comment = `## ğŸ‘¤ ë‹´ë‹¹ì ìë™ í• ë‹¹
              
              ${urgentText}
              
              **ë‹´ë‹¹ì**: @${selectedAssignee}
              **ë¶„ì•¼**: ${assigneeCategory}
              **í• ë‹¹ ì´ìœ **: ${getAssignmentReason(assigneeCategory, title, body)}
              
              ### ë‹´ë‹¹ì ê°€ì´ë“œ
              - ì´ˆê¸° ì‘ë‹µ: ${isUrgent ? '2ì‹œê°„ ë‚´' : '24ì‹œê°„ ë‚´'}
              - ë¶„ì„ ì™„ë£Œ: ${isUrgent ? '24ì‹œê°„ ë‚´' : '3-5ì¼ ë‚´'}
              - ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ ì£¼ê¸°: ì£¼ 2íšŒ
              
              ë‹´ë‹¹ìê°€ ë³€ê²½ë˜ì–´ì•¼ í•  ê²½ìš° ì–¸ì œë“  ì¬í• ë‹¹ ìš”ì²­í•´ì£¼ì„¸ìš”.
              
              ---
              ğŸ¤– ë‹´ë‹¹ìëŠ” ì´ìŠˆ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

            function getAssignmentReason(category, title, body) {
              switch(category) {
                case 'backend':
                  return 'ë°±ì—”ë“œ/API ê´€ë ¨ í‚¤ì›Œë“œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤';
                case 'frontend':
                  return 'í”„ë¡ íŠ¸ì—”ë“œ/UI ê´€ë ¨ í‚¤ì›Œë“œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤';
                case 'docs':
                  return 'ë¬¸ì„œ ê´€ë ¨ í‚¤ì›Œë“œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤';
                case 'devops':
                  return 'DevOps/CI-CD ê´€ë ¨ í‚¤ì›Œë“œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤';
                case 'fullstack':
                  return 'ë²„ê·¸ë‚˜ ë³µí•©ì ì¸ ì´ìŠˆë¡œ íŒë‹¨ë˜ì–´ í’€ìŠ¤íƒ ê°œë°œìê°€ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤';
                default:
                  return 'ì¼ë°˜ì ì¸ ìœ ì§€ë³´ìˆ˜ ë‹´ë‹¹ìê°€ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤';
              }
            }

  notify-urgent:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, 'urgent') || contains(github.event.issue.title, 'critical')

    steps:
      - name: Notify urgent issue
        uses: actions/github-script@v7
        with:
          script: |
            // ê¸´ê¸‰ ì´ìŠˆì˜ ê²½ìš° ì¶”ê°€ ì•Œë¦¼ ë¡œì§
            const comment = `## ğŸš¨ ê¸´ê¸‰ ì´ìŠˆ ì¶”ê°€ ì•Œë¦¼

            ì´ ì´ìŠˆëŠ” ê¸´ê¸‰ìœ¼ë¡œ ë¶„ë¥˜ë˜ì–´ ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ë³„ ì²˜ë¦¬ê°€ ì ìš©ë©ë‹ˆë‹¤:

            ### ğŸ”¥ ê¸´ê¸‰ ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤
            1. **ì¦‰ì‹œ ì•Œë¦¼**: ëª¨ë“  ê´€ë ¨ íŒ€ì›ì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼
            2. **ìš°ì„  ì²˜ë¦¬**: ë‹¤ë¥¸ ì‘ì—…ë³´ë‹¤ ìš°ì„ í•˜ì—¬ ì²˜ë¦¬
            3. **ë¹ ë¥¸ ì‘ë‹µ**: 2ì‹œê°„ ë‚´ ì´ˆê¸° ì‘ë‹µ í•„ìš”
            4. **ì •ê¸° ì—…ë°ì´íŠ¸**: 6ì‹œê°„ë§ˆë‹¤ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸

            ### ğŸ“ ì—ìŠ¤ì»¬ë ˆì´ì…˜
            24ì‹œê°„ ë‚´ í•´ê²°ë˜ì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ ìƒìœ„ ê´€ë¦¬ìì—ê²Œ ì—ìŠ¤ì»¬ë ˆì´ì…˜ë©ë‹ˆë‹¤.

            ---
            ğŸš¨ ê¸´ê¸‰ ì´ìŠˆ íŠ¹ë³„ ì²˜ë¦¬ ì•ˆë‚´`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # 24ì‹œê°„ í›„ ë¯¸í• ë‹¹ ì´ìŠˆ í™•ì¸ (ìŠ¤ì¼€ì¤„ëŸ¬ë¡œ ë³„ë„ ê´€ë¦¬ ê°€ëŠ¥)
  check-unassigned:
    runs-on: ubuntu-latest

    steps:
      - name: Check if issue needs attention
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // ì´ìŠˆê°€ ìƒì„±ëœì§€ 24ì‹œê°„ í›„ì— ì‹¤í–‰ë˜ëŠ” ë¡œì§
            // (ì‹¤ì œë¡œëŠ” scheduled workflowë¡œ êµ¬í˜„í•˜ëŠ” ê²ƒì´ ë” ì ì ˆ)

            const comment = `## â° ì´ìŠˆ ì²˜ë¦¬ ì•Œë¦¼

            ì´ ì´ìŠˆê°€ ìƒì„±ëœ ì§€ ì‹œê°„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤.

            ### ğŸ“‹ í˜„ì¬ ìƒíƒœ í™•ì¸
            - ë‹´ë‹¹ì í• ë‹¹ ì—¬ë¶€
            - ë¼ë²¨ ì ìš© ì—¬ë¶€  
            - ì´ˆê¸° ì‘ë‹µ ì—¬ë¶€

            ë‹´ë‹¹ìê°€ ì•„ì§ í• ë‹¹ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ìˆ˜ë™ìœ¼ë¡œ í• ë‹¹í•´ì£¼ì„¸ìš”.

            ---
            ğŸ¤– ì •ê¸° ì´ìŠˆ ìƒíƒœ í™•ì¸`;

            // ì‹¤ì œ êµ¬í˜„ì‹œì—ëŠ” ì¡°ê±´ë¶€ë¡œ ì‹¤í–‰
            // if (!issue.assignees.length) { ... }
            console.log('Issue status check completed');
