name: PR Auto Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Automated Code Review
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            let reviewComments = [];
            let generalComments = [];

            // ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸
            const checkList = {
              hasTests: false,
              hasDocumentation: false,
              hasBreakingChanges: false,
              hasSecurityIssues: false,
              codeComplexity: 'medium',
              totalChanges: 0
            };

            // íŒŒì¼ë³„ ë¶„ì„
            for (const file of files) {
              checkList.totalChanges += file.changes;
              
              // í…ŒìŠ¤íŠ¸ íŒŒì¼ í™•ì¸
              if (file.filename.includes('test_') || file.filename.includes('/tests/')) {
                checkList.hasTests = true;
              }
              
              // ë¬¸ì„œ íŒŒì¼ í™•ì¸  
              if (file.filename.includes('.md') || file.filename.includes('/docs/')) {
                checkList.hasDocumentation = true;
              }
              
              // ë³´ì•ˆ ê´€ë ¨ íŒ¨í„´ í™•ì¸
              if (file.patch) {
                const securityPatterns = [
                  /password\s*=\s*['"]/i,
                  /api_key\s*=\s*['"]/i,
                  /secret\s*=\s*['"]/i,
                  /token\s*=\s*['"]/i,
                  /eval\(/i,
                  /exec\(/i
                ];
                
                for (const pattern of securityPatterns) {
                  if (pattern.test(file.patch)) {
                    checkList.hasSecurityIssues = true;
                    reviewComments.push({
                      path: file.filename,
                      body: `âš ï¸ **ë³´ì•ˆ ì£¼ì˜**: ë¯¼ê°í•œ ì •ë³´ë‚˜ ìœ„í—˜í•œ í•¨ìˆ˜ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ ì¬ê²€í† í•´ì£¼ì„¸ìš”.`,
                      line: 1
                    });
                    break;
                  }
                }
                
                // ë³µì¡ë„ ì²´í¬ (ê°„ë‹¨í•œ íœ´ë¦¬ìŠ¤í‹±)
                const complexity = (file.patch.match(/if\s*\(/g) || []).length +
                                 (file.patch.match(/for\s*\(/g) || []).length +
                                 (file.patch.match(/while\s*\(/g) || []).length +
                                 (file.patch.match(/def\s+/g) || []).length;
                
                if (complexity > 10) {
                  checkList.codeComplexity = 'high';
                  reviewComments.push({
                    path: file.filename,
                    body: `ğŸ”„ **ë³µì¡ë„ ë†’ìŒ**: ì´ íŒŒì¼ì˜ ë³µì¡ë„ê°€ ë†’ìŠµë‹ˆë‹¤. í•¨ìˆ˜ë¥¼ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`,
                    line: 1
                  });
                }
              }
            }

            // ì „ì²´ì ì¸ ë¦¬ë·° ì½”ë©˜íŠ¸ ìƒì„±
            let overallReview = `## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·°

            ### ğŸ“Š ë³€ê²½ì‚¬í•­ ë¶„ì„
            - **ì´ ë³€ê²½ íŒŒì¼**: ${files.length}ê°œ
            - **ì´ ë³€ê²½ ë¼ì¸**: ${checkList.totalChanges}ì¤„
            - **ì½”ë“œ ë³µì¡ë„**: ${checkList.codeComplexity}

            ### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ ê²°ê³¼
            `;

            overallReview += checkList.hasTests ? 
              '- âœ… í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤\n' : 
              '- âŒ í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì½”ë“œ ì¶”ê°€ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤\n';
              
            overallReview += checkList.hasDocumentation ? 
              '- âœ… ë¬¸ì„œ ì—…ë°ì´íŠ¸ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤\n' : 
              '- âš ï¸ ë¬¸ì„œ ì—…ë°ì´íŠ¸ë¥¼ ê²€í† í•´ë³´ì„¸ìš”\n';
              
            if (checkList.hasSecurityIssues) {
              overallReview += '- âš ï¸ ë³´ì•ˆ ê²€í† ê°€ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤\n';
            } else {
              overallReview += '- âœ… ëª…ë°±í•œ ë³´ì•ˆ ì´ìŠˆëŠ” ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤\n';
            }

            // ê¶Œì¥ì‚¬í•­
            overallReview += `
            ### ğŸ’¡ ê¶Œì¥ì‚¬í•­
            `;

            if (!checkList.hasTests) {
              overallReview += '- ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ë‚˜ ë²„ê·¸ ìˆ˜ì •ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”\n';
            }

            if (checkList.totalChanges > 500) {
              overallReview += '- í° ê·œëª¨ì˜ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤. PRì„ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”\n';
            }

            if (checkList.codeComplexity === 'high') {
              overallReview += '- ë³µì¡í•œ ë¡œì§ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì½”ë“œ ë¦¬ë·°ì— ì¶©ë¶„í•œ ì‹œê°„ì„ í• ì• í•´ì£¼ì„¸ìš”\n';
            }

            overallReview += `
            ### ğŸ” ìˆ˜ë™ ë¦¬ë·° í¬ì¸íŠ¸
            - API ë³€ê²½ì‚¬í•­ì´ í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ ì§€í•˜ëŠ”ì§€ í™•ì¸
            - ì—ëŸ¬ ì²˜ë¦¬ê°€ ì ì ˆíˆ êµ¬í˜„ë˜ì—ˆëŠ”ì§€ ì ê²€
            - ì„±ëŠ¥ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ ê²€í† 
            - ë³´ì•ˆ ì·¨ì•½ì  ì¬ê²€í† 

            ---
            ğŸ¤– ì´ ë¦¬ë·°ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ë¦¬ë·°ë„ ë°˜ë“œì‹œ ì§„í–‰í•´ì£¼ì„¸ìš”.`;

            // ì „ì²´ ë¦¬ë·° ëŒ“ê¸€ ë“±ë¡
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: overallReview
            });

            // ê°œë³„ íŒŒì¼ ë¦¬ë·° ëŒ“ê¸€ ë“±ë¡
            for (const comment of reviewComments) {
              try {
                await github.rest.pulls.createReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  path: comment.path,
                  body: comment.body,
                  commit_id: pr.head.sha,
                  line: comment.line
                });
              } catch (error) {
                console.log(`Could not create review comment for ${comment.path}: ${error.message}`);
              }
            }

  performance-check:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'backend/')

    steps:
      - uses: actions/checkout@v4

      - name: Performance Analysis
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âš¡ ì„±ëŠ¥ ë¶„ì„ ì•Œë¦¼

            ë°±ì—”ë“œ ì½”ë“œ ë³€ê²½ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì„±ëŠ¥ ê´€ë ¨ ì‚¬í•­ë“¤ì„ ê²€í† í•´ì£¼ì„¸ìš”:

            ### ğŸ” ì„±ëŠ¥ ì²´í¬í¬ì¸íŠ¸
            - [ ] ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™” í™•ì¸
            - [ ] N+1 ì¿¼ë¦¬ ë¬¸ì œ ì—†ëŠ”ì§€ ì ê²€
            - [ ] ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì˜í–¥ ê²€í† 
            - [ ] API ì‘ë‹µ ì‹œê°„ í…ŒìŠ¤íŠ¸
            - [ ] ë™ì‹œì„± ì²˜ë¦¬ ê²€í† 
            - [ ] ìºì‹± ì „ëµ ì ìš© í™•ì¸

            ### ğŸ“Š ê¶Œì¥ í…ŒìŠ¤íŠ¸
            \`\`\`bash
            # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì˜ˆì‹œ
            cd backend
            python -m pytest tests/performance/ -v
            \`\`\`

            ---
            ğŸ¤– ì„±ëŠ¥ ê´€ë ¨ ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œ ìë™ìœ¼ë¡œ ì•Œë¦¼ë©ë‹ˆë‹¤.`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
